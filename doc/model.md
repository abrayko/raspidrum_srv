

# Виды моделей

Модели разделяются на два класса:
 - мета описание
 - настройки

##  Мета описание

Служит для описания сущностей. На основе описания рисуется UI.

## Настройки

Служит для хранения и управления настройками семплера, микшера, китов и пр.


# Киты

Кит - набор семплов барабанной установки. Опционально может включать дополнительные слои (layer) для инструментов, например, OH (overhead), top и bottom для snare.

Fx - эффект. Может содержать цепочку эффектов, к-е обрабатывают звук последовательно.

Канал - обобщающая сущность, отвечающая для воспроизведение нескольких инструментов или нескольких слоев одного инструмента.

В ките настраивается:
 - название
 - движок (sfz, sf2, gig и пр.)
 - набор инструментов. Каждый содержит:
  - набор слоев (слоев может не быть, что означает только один основной слой)
    - в каждом слое набор семплов
    - значения по умолчанию:
      - уровень
      - панорама
  - возможность тюнинга:
      - pitch - может быть только для всех слоев инструмента сразу, иначе получится "каша"
      - ??? (eq, reverb - некторые движки и семплеры поддерживают)

## Пресеты

Для использования кита необходим пресет.
В пресете настраивается:
 - название
 - распределение инструментов кита по каналам. Каждый канал содержит:
   - уровень (см. Примечание 3)
   - панораму (см. Примечание 3)
   - цепочка fx для канала (см. Примечание 2 ниже)
 - в одном канале может быть несколько инструментов
   - для SFZ для каждого инструмента может быть свой tune (pitch, возможно eq, reverb и пр.) и volume и pan
   - для GIG возможны настройки для каждого сэмпла, но только в редакторе, а через API нельзя. Т.о. для каждого инструмента отдельный tune невозможен
   - для SF2 - хз
 - слои инструмента (только если в канале один инструмент. см. Примечание 1 ниже)
   - список слоев
   - уровень каждого слоя
   - ~~панорама~~
   - цепочка fx для слоя (если канал содержит более одного слоя инструмента. см. Примечание 2 ниже)
 - настройки инструмента (например, Pitch) (возможно, будет настраиваться с помощью fx)
 - каналы микшера. Для каждого канала:
   - уровень
   - панорама
   - маршрутизация (в какую пару каналов звуковой карты выводить, если пар больше одной)
 - глобальный канал - канал после микшера и маршрутизации. Кол-во определяется кол-вом пар каналов звуковой карты
   - уровень
   - цепочка fx

  
Пресет привязывается к конкретному киту. Пресет не может быть использован для разных китов, т.к. в одном ките может быть несколько слоев инструмента, а в другом ките может вообще не быть слоев. Также, кит могут быть в различных форматах (SFZ, SF2, GIG) и использовать различные движки (fluidsynth, linuzsampler и пр.)

*Примечание 1: если инстумент содержит дополнительные слои (layer), то он не может быть включен вместе со слоями в один канал с другими инструментами. Допускается включение только одного слоя при объединении в один канал. (TODO: может это вымышленное ограничение. Нужно проверить спецификации форматов SFZ, SF2 и GIG. Если все-таки можно, то скорее всего регулировать уровни слоев не получится).*

Примечание 2: 
- В LinuxSampler каждый слой загружается в отдельный канал семплера. Т.к. fx в семплере настраивается для только для канала, то при наличии нескольких слоев у инструмента возможна настройка только fx для каждого канала. Общий fx на весь инструмент настроить нет возможности, т.к. в семплере отсутствует объединяющий слои канал. Возможно, такое можно реализовать путем запуска отдельных семплеров для каждого интструмента (например, в FluidSynth). Если же канал содержит только один основной слой инструмента, то слой фактически и есть канал.
- В sfizz/fluidsynth, возможно задавать fx как для канала, так и для каждого слоя отдельно. Скорее всего это возможно путем запуска отдельного процесса, подключения его к отдельному порту Jack и использование fx уже через Jack в виде LV2. А для каждого слоя fx реализовывать плагином в самом семплере (скорее всего LADSPA).


*Примечание 3: Если канал содержит несколько слоев, то общего канала для всехслоев нет (см. примечание 1). В таком случае при регулировке уровня или панорамы канала в целом математически пересчитывается уровень и панорама каждого слоя. Данный пересчет выполняется только на бэке и не виден в UI. Например, канал содержит два слоя. Слой 1 имеет уровень 80%, а слой 2 - уровень 60%. Если общий уровень канала выставить в 50%, то в семплере уровни каналов, соответствующие слоям будут иметь значения 40% и 30% соответственно. Но в UI уровни слоев будут отображаться также: 80% и 60%.*


### Возможные варианты конфигурации пресетов

#### LinuxSampler

Настройки уровня, pan, fx может выполняться только в рамках канала. Т.о. если инструмент требуется настраивать индивидуально, то он должен быть в отдельном канале семплера.
Для SFZ похоже может настраиваться tune индивидуально для инструмента, путем отправки MIDI CC - нужно проверить.
Аналогично со слоями инструмента.
Семплер не имеет сущности "инструмент" и "слой", а только канал.

**Вариант 1 - Все инструменты вместе**
В пресете только один канал.
Канал - реальный канал семплера.
В канале перечислены все инструменты. Если у инструментов есть слои, то в пресете они не отражаются, т.к. никак не настраиваются.

<details>
  <summary>Варианты настройки</summary>

Вариант 1.1:
  - канал: volume, pan, tune и fx
  - инструмент: нет

Вариант 1.2: (скорее только SFZ)
 - канал: volume, pan, fx
 - инструмент: tune

Вариант 1.3: (продвинутый SFZ - требует проверки)
  - канал: volume, pan, fx
  - инструмент: gain, pan, tune

В варианте 3 volume и pan для канала - это именно реальный канал и реальные настройки. gain и pan для инструмента настраивается через MIDI CC, независимо от настройки канала.

</details>

**Вариант 2 - Каждый инструмент в своем канале**
В пресете кол-во каналов по кол-ву инструментов.
Каждый канал - реальный канал семплера.
В канале только один инструмент. Если у инструментов есть слои, то в пресете они не отражаются, т.к. никак не настраиваются.

<details>
  <summary>Варианты настройки</summary>

Вариант 1:
  - канал: volume, pan, tune и fx
  - инструмент: нет

Вариант 2 (продвинутый SFZ, один инструмент в канале - см. Вариант 1.3):
  - канал: volume, pan, fx
  - инструмент: tune
  
Вариант 3 (продвинутый SFZ, несколько инструментов в канале - см. Вариант 1.3):
  - канал: volume, pan, fx
  - инструмент: gain, pan, tune

Примечание: если в канале только один инструмент, то регулировка gain,pan через MIDI CC выглядит избыточно и будет только путать.


```yaml
channels:
- key: 1
  name: Kick
  level: 0.97
  pan: 0.0
  fxs: 
  - ...
  instruments:
  - key: kick
    name: Kick
    tunes:
    - ...
- key: 2
  name: Toms
  level: 0.87
  pan: 0.1
  fxs:
  - ...
  instruments:
    - key: tom1
      name: Tom 1
      level: 0.8
      pan: 0.0
      tunes:
      - ...
    - key: tom2
      name: Tom 2
      level: 0.9
      pan: 0.1
      tunes:
      - ...
```

</details>

**Вариант 3 - У инструментов настраиваются слои**
В пресете кол-во каналов по кол-ву инструментов.
Канал инструмента, содержащий слой, является виртуальным. Относится как один-ко-многим: один канал инструмента - много каналов семплера.
В канале один инструмент. Если у инструмента есть слой, то присутствует настройка в пресете.
Каждый слой располагается в отдельном канале семплера.

- канал: volume, pan
- инструмент: volume, pan, tune (скорее только pitch)
- слой: volume, pan, fx

Примечание: 
 - виртуальный канал пропорционально регулирует volume и pan каждого канала слоя
 - level и pan инструмента пропорционально регулируют level и pan всех слоев
 - если слой один, то либо скрывать его, перенося все настройки инструмент, либо volume и pan инструмента являются опциональными и регулируют пропорционально настройки слоя

<details>
  <summary>Варианты настройки</summary>

```yaml
channels:
- key: 1
  name: Kick
  level: 0.97
  pan: 0.0
  fxs: 
  - ...
  instruments:
  - key: kick
    name: Kick
    tunes:
    - ...
- key: 2
  name: Snare
  level: 0.9
  pan: 0.0
  instruments:
  - key: snare
    name: Snare
    tunes:
    - ...
    layers:
    - key: snare_top
      name: Top
      level: 0.7
      pan: 0.0
      fxs:
      - ...
    - key: snare_bottom
      name: Bottom
      level: 0.8
      pan: -0.05
      fxs:
      - ...
- key: 3
  name: crash
  level: 0.7
  pan: -0.15
  instruments:
  - key: crash
    name: Crash
    tunes:
    - ...
    layers:
    - key: crash_oh
      name: OH
      level: 0.9
      pan: 0.0
      fxs:
      - ...
- key: 4
  name: Toms
  level: 0.9
  pan: 0.0
  instruments:
  - key: tom1
    name: Tom1
    level: 0.8
    pan: 0.0
    tunes:
    - ...
    layers:
    - key: tom1_bottom
      name: Bottom
      level: 0.7
      pan: 0.0
      fxs:
      - ..
    - key: tom1_oh
      name: OH
      level: 0.9
      pan: 0.0
      fxs:
      - ..
  - key: tom3
    name: Floor Tom
    tunes:
    - ...
    layers:
      - key: tom3_oh
        name: OH
        level: 0.9
        pan: 0.4
        fxs:
        - ...
```

</details>

**Вариант 4 - Смешанный**
Для одних инструментов по варианту 2, для других по варианту 3.

#### fluidsynth (SF2)

#### sfizz (SFZ) 

Настройка fx выполняется только для каждого канала семплера с помощью LADSPA (не уверен, поддерживает ли это sfizz).
Формат SFZ не имеет сущности "инструмент" и "слой", а только группа семплов (region). Для одного инструмента может быть несколько групп (слоев).
Фактически настройки выполняются только для группы семплов (слоя).
У слоя настраивается volume, и, возможно pan, tune. Настройка volume через API, а pan и tune - через MIDI CC (следует проверить).

**Вариант 1 - Все инструменты вместе**
В пресете только один канал.
Канал - реальный канал сеплера.
В канале перечислены все инструменты. Если у 




TODO: как удобно реализовать распределение инструментов по каналам или все-таки оставить настройкой в ките?
Варианты:
- авторежимы: 
  - все в один канал (доступен при отсутствии слоев)
  - все в разные каналы
  - по группам - создает каналы:
    - KICK
    - SNARE
    - HH
    - CYMBALS (crash, ride и пр.)
    - TOMS